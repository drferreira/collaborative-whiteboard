<ui:composition template="../../templates/generic.xhtml" xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui">

    <ui:define name="pageContent">
        <h:form id="backlogForm" prependId="false">
            <p:toolbar styleClass="toolbar">
                <f:facet name="left">
                    <p:commandButton icon="ui-icon-plus" value="#{backlog['btn.add']}"
                                     oncomplete="PF('storyCreation').show();"/>
                </f:facet>
            </p:toolbar>

            <div>
                <p:dataTable id="backlogTable" var="story"
                             value="#{backlogController.fetchStories()}"
                             widgetVar="backlogTbl"
                             rowIndexVar="index" selection="#{editionStoryController.selectedStory}"
                             rowKey="#{story.id}"
                             rowStyleClass="#{backlogController.isRemoved(story) ? 'storyRemoved' : null}"
                             selectionMode="single">

                    <p:column styleClass="color_column_standart" filterBy="#{story}" filterMatchMode="in"
                              filterFunction="#{backlogController.filterByStatus}">
                        <div class="color_#{backlogController.getStatus(story)} color_flag_standart"/>
                        <f:facet name="filter">
                            <p:selectCheckboxMenu label="Status" onchange="PF('backlogTbl').filter()" filter="false">
                                <p:ajax event="toggleSelect" oncomplete="PF('backlogTbl').filter()"/>
                                <f:selectItems value="#{backlogController.fetchStatus()}" var="status"
                                               itemLabel="#{backlog['story.status.'.concat(status)]}"/>
                            </p:selectCheckboxMenu>
                        </f:facet>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.priority']}"
                              style="width: 16%;height: 35px; text-align: center;">
                        <p:rating value="#{story.priority}" stars="10" readonly="true"/>
                    </p:column>

                    <p:column headerText="#{backlog['header.table.project']}"
                              style="width: 6%;height: 35px; text-align: center;">
                        <h:outputText value="#{story.project.nameProject}"/>
                    </p:column>

                    <p:column filterBy="#{story.subject}" filterMatchMode="contains"
                              headerText="#{backlog['header.table.subject']}"
                              style="width: 60%;height: 35px; text-align: center;" filterStyle="width: 95%;">
                        <h:outputText value="#{story.subject}"/>
                    </p:column>

                    <p:column filterBy="#{story.code}" filterMatchMode="contains"
                              headerText="#{backlog['header.table.code']}"
                              style="width: 15%;height: 35px; text-align: center;" filterStyle="width: 92%;">
                        <h:outputText value="#{story.code}"/>
                    </p:column>

                    <p:column filterBy="#{story.branch}" filterMatchMode="contains"
                              headerText="#{backlog['header.table.branch']}"
                              style="width: 15%;height: 35px; text-align: center;" filterStyle="width: 92%;">
                        <h:outputText value="#{story.branch}"/>
                    </p:column>

                    <p:column filterMatchMode="exact" headerText="#{backlog['header.table.area']}"
                              style="width: 15%;height: 35px; text-align: center;">
                        <h:outputText value="#{story.projectArea.name}"/>
                    </p:column>
                </p:dataTable>

                <p:contextMenu for=":backlogForm:backlogTable">
                    <p:menuitem value="#{backlog['btn.open']}" icon="ui-icon-folder-open"
                                oncomplete="PF('storyDetail').show()" update=":backlogForm:backlogTable :storyDetail"/>
                    <p:menuitem value="#{backlog['btn.voting']}" icon="ui-icon-note" action="#{editionStoryController.voting()}" />
                </p:contextMenu>
            </div>
        </h:form>

        <p:dialog id="storyDetail" widgetVar="storyDetail" modal="true" resizable="false" appendToBody="false">
            <p:outputPanel id="storyDetailPanel">
                <h:form id="storyDetailForm" prependId="false" enctype="multipart/form-data">
                    <div class="story_backlog color_#{editionStoryController.status}">
                        <h:outputText value="#{status_bundle['story.status.'.concat(editionStoryController.status)]}"
                                      style="text-align: center; font-size: 30px !important;"/>
                    </div>

                    <p:spacer height="5px"/>

                    <p:toolbar>
                        <f:facet name="left">
                            <p:commandButton id="storyDetailSave" value="#{backlog['btn.save']}"
                                             action="#{editionStoryController.save()}"
                                             onsuccess="PF('backlogTbl').filter();"
                                             update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-disk">
                                <f:param name="required_validation" value="true"/>
                            </p:commandButton>

                            <p:commandButton id="storyDetailCancel" value="#{backlog['btn.cancel']}"
                                             oncomplete="PF('storyDetail').hide()" icon="ui-icon-arrowreturnthick-1-w"
                                             immediate="true">
                            </p:commandButton>

                            <p:commandButton id="storyStatusRestore" value="#{backlog['btn.restore']}"
                                             action="#{editionStoryController.restore()}"
                                             update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-check"
                                             disabled="#{!editionStoryController.isPossibleRestore()}">

                                <f:param name="required_validation" value="true"/>
                            </p:commandButton>

                             <span class="ui-separator">
                                <span class="ui-icon ui-icon-grip-dotted-vertical"/>
                            </span>

                            <p:commandButton id="storyStatusAvailable" value="#{backlog['btn.available']}"
                                             action="#{editionStoryController.provide()}"
                                             update="storyDetailForm,:backlogForm:backlogTable" icon="ui-icon-check"
                                             disabled="#{!editionStoryController.isPossibleProvide()}"
                                             immediate="true">

                                <p:confirm message="#{backlog['confirmation.change_status.text']}"
                                           icon="ui-icon-alert"/>
                            </p:commandButton>


                            <p:commandButton id="storyVoting" value="#{backlog['btn.voting']}"
                                             action="#{editionStoryController.voting()}"
                                             icon="ui-icon-note"
                                             immediate="true"/>

                            <p:menuButton value="#{backlog['btn.analysis']}"
                                          disabled="#{!editionStoryController.isPossibleAnalyze()}">
                                <p:menuitem value="#{backlog['btn.analysis.init']}" icon="ui-icon-play"
                                            update="storyDetailForm,:backlogForm:backlogTable"
                                            action="#{editionStoryController.initAnalysis()}"
                                            disabled="#{!editionStoryController.isPossibleInitAnalyze()}">
                                    <f:attribute name="required_validation" value="true"/>
                                </p:menuitem>

                                <p:menuitem value="#{backlog['btn.analysis.end']}" icon="ui-icon-stop"
                                            update="storyDetailForm,:backlogForm:backlogTable"
                                            action="#{editionStoryController.endAnalysis()}"
                                            disabled="#{!editionStoryController.isPossibleEndAnalyze()}">
                                    <f:attribute name="required_validation" value="true"/>
                                </p:menuitem>
                            </p:menuButton>
                        </f:facet>
                        <f:facet name="right">
                            <p:commandButton id="removeButton" styleClass="warning_button" icon="ui-icon-trash"
                                             value="#{backlog['btn.remove']}"
                                             update="storyDetailForm,:backlogForm:backlogTable"
                                             action="#{editionStoryController.removeStory()}" immediate="true">
                                <p:confirm message="#{backlog['confirmation.remove.text']}"
                                           icon="ui-icon-alert"/>
                            </p:commandButton>
                        </f:facet>
                    </p:toolbar>

                    <p:spacer height="10px"/>

                    <p:tabView style="width: 830px">
                        <p:tab title="#{backlog['tab.story.title']}">
                            <div id="wikiArea" style="margin-top: 7px;">
                                <p:commandButton icon="ui-icon-pencil" onclick="PF('editionWikiPage').jq.show()"
                                                 immediate="true"/>
                                <p:spacer width="10px"/>
                                <p:commandLink disabled="#{empty editionStoryController.storyEdition.wikiPage}"
                                               ajax="false"
                                               action="#{editionStoryController.openWiki}"
                                               value="#{backlog['label.wiki_link']}" target="_blank" immediate="true"/>
                                <br/>
                                <p:inputText widgetVar="editionWikiPage"
                                             value="#{editionStoryController.storyEdition.wikiPage}" size="90"
                                             style="display:none;margin-top: 10px;"/>
                            </div>

                            <h:panelGrid columns="2">
                                <h:column>
                                    <h:outputLabel value="#{backlog['label.story_points']}" for="storyPoints"/>
                                </h:column>

                                <h:column>
                                    <p:inputMask mask="9?9" id="storyPoints"
                                                 value="#{editionStoryController.storyEdition.storyPoints}"
                                                 maxlength="2"
                                                 size="2" style="width: 20px;"
                                                 required="#{empty param.required_validation}"
                                                 requiredMessage="#{messages['mandatory.field']}"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.priority']}" for="priority"/>
                                </h:column>

                                <h:column>
                                    <p:rating id="priority" value="#{editionStoryController.storyEdition.priority}"
                                              stars="10" cancel="false"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.creation_date']}" for="creationDate"/>
                                </h:column>

                                <h:column>
                                    <p:calendar id="creationDate"
                                                value="#{editionStoryController.storyEdition.creationDate}"
                                                disabled="true" pattern="dd/MM/yyyy HH:mm"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.code']}" for="code"/>
                                </h:column>

                                <h:column>
                                    <p:inputText id="code" value="#{editionStoryController.storyEdition.code}"
                                                 readonly="true"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.branch']}" for="branch"/>
                                </h:column>

                                <h:column>
                                    <p:inputText id="branch" value="#{editionStoryController.storyEdition.branch}"
                                                 requiredMessage="#{messages['mandatory.field']}"/>
                                </h:column>

                                <h:column>
                                    <p:message for="branch"/>

                                    <h:outputLabel value="#{backlog['label.area']}" for="area"/>
                                </h:column>

                                <h:column>
                                    <p:inputText id="area"
                                                 value="#{editionStoryController.storyEdition.projectArea.name}"
                                                 readonly="true" size="68"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.author']}" for="author"/>
                                </h:column>

                                <h:column>
                                    <p:inputText id="author"
                                                 value="#{editionStoryController.storyEdition.author.fullName}"
                                                 readonly="true" size="68"/>
                                </h:column>

                                <h:column>
                                    <h:outputLabel value="#{backlog['label.subject']}" for="subject"/>
                                </h:column>

                                <h:column>
                                    <p:inputText id="subject"
                                                 value="#{editionStoryController.storyEdition.subjectChanges}"
                                                 requiredMessage="#{messages['mandatory.field']}" required="true"
                                                 size="68"/>
                                    <p:message for="subject"/>
                                </h:column>
                            </h:panelGrid>

                            <p:message for="description"/>
                            <p:editor id="description"
                                      value="#{editionStoryController.storyEdition.descriptionChanges}"
                                      cols="110"
                                      rows="10" requiredMessage="#{messages['mandatory.field']}"/>
                        </p:tab>
                        <p:tab title="#{backlog['tab.file.title']}">
                            <p:fileUpload fileUploadListener="#{editionStoryController.uploadFile}" mode="advanced"
                                          dragDropSupport="true" sizeLimit="10485760" multiple="true" update="files"/>

                            <p:spacer height="10px"/>

                            <p:outputPanel>
                                <p:dataTable id="files" rows="8" paginator="true" var="file"
                                             value="#{editionStoryController.fetchFiles()}">
                                    <p:column>
                                        <h:outputText value="#{file.fileName}"/>
                                    </p:column>
                                    <p:column width="90" style="text-align: center">
                                        <p:commandButton icon="ui-icon-trash" immediate="true"
                                                         action="#{editionStoryController.remove(file)}" process="@this"
                                                         update="files"/>
                                        <p:commandButton icon="ui-icon-arrowthickstop-1-s" immediate="true"
                                                         ajax="false">
                                            <p:fileDownload value="#{editionStoryController.download(file)}"/>
                                        </p:commandButton>
                                    </p:column>
                                </p:dataTable>
                            </p:outputPanel>
                        </p:tab>
                    </p:tabView>
                </h:form>
            </p:outputPanel>
        </p:dialog>

        <p:dialog id="storyCreation" widgetVar="storyCreation" modal="true" resizable="false" appendToBody="false">
            <h:form id="createStoryForm" prependId="false">
                <p:toolbar>
                    <f:facet name="left">
                        <p:commandButton id="save" value="#{backlog['btn.save']}"
                                         update="@form,:backlogForm:backlogTable"
                                         action="#{creationStoryController.create()}" icon="ui-icon-disk"/>
                        <p:commandButton id="cancel" value="#{backlog['btn.cancel']}"
                                         action="#{creationStoryController.cancel()}"
                                         oncomplete="PF('storyCreation').hide()" icon="ui-icon-arrowreturnthick-1-w"
                                         immediate="true">
                            <p:ajax update="createStoryForm" resetValues="true"/>
                        </p:commandButton>
                    </f:facet>
                </p:toolbar>

                <p:spacer height="10" />

                <h:panelGrid columns="1">
                    <p:selectOneMenu id="projectNewStory" value="#{creationStoryController.project}"
                                     required="true" requiredMessage="#{messages['mandatory.field']}">
                        <f:selectItem itemLabel="#{backlog['label.story.creation.select_empty']}" itemValue=""/>
                        <p:ajax event="change" execute="@this" update="projectArea"/>
                        <f:selectItems value="#{creationStoryController.projects}" var="projectName"
                                       itemLabel="#{projectName}" itemValue="#{projectName}"/>
                    </p:selectOneMenu>
                    <p:message for="projectNewStory"/>

                    <p:autoComplete id="projectArea" forceSelection="true" dropdown="true" itemLabel="#{area}"
                                    var="area" value="#{creationStoryController.projectArea}"
                                    completeMethod="#{creationStoryController.fetchProjectAreas}" itemValue="#{area}"
                                    required="true" requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="projectArea"/>

                    <p:watermark value="#{backlog['label.story.creation.subject']}" for="subjecNewStory"/>
                    <p:inputText id="subjecNewStory" value="#{creationStoryController.storyCreation.subject}"
                                 size="60" required="true" requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="subjecNewStory"/>

                    <p:watermark value="#{backlog['label.story.creation.description']}"
                                 for="descriptionNewStory"/>
                    <p:editor id="descriptionNewStory"
                              value="#{creationStoryController.storyCreation.description}"
                              cols="63" rows="20" required="true"
                              requiredMessage="#{messages['mandatory.field']}"/>
                    <p:message for="descriptionNewStory"/>
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:confirmDialog global="true" widgetVar="confirmationDialog" modal="true" resizable="false">
            <p:outputPanel>
                <h:panelGrid columns="2">
                    <h:form>
                        <p:commandButton value="#{backlog['btn.save']}" update=":backlogForm:backlogTable"
                                         styleClass="ui-confirmdialog-yes" icon="ui-icon-check"/>
                        <p:commandButton value="#{backlog['btn.cancel']}"
                                         type="button"
                                         styleClass="ui-confirmdialog-no" icon="ui-icon-close"/>
                    </h:form>
                </h:panelGrid>
            </p:outputPanel>
        </p:confirmDialog>

    </ui:define>
</ui:composition>